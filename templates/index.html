<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kach-7aja Quote Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col">
    <header class="bg-indigo-600 text-white p-4">
        <h1 class="text-2xl font-bold text-center">Kach-7aja Quote Generator</h1>
    </header>
    <main class="max-w-3xl mx-auto p-4 flex-grow">
        <div class="mb-6 flex gap-4 justify-center">
            <a href="/random-quote" class="bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600 transition">Get Random Quote</a
        >
        <a
          href="/add-quote"
          class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition"
          >Add New Quote</a
        >
      </div>
      {% if quotes %}
      <div class="grid gap-4">
        {% for quote in quotes %}
        <div id="quote-{{ quote.id }}" class="bg-white p-4 rounded-lg shadow-md">
          <p class="text-gray-800 italic">"{{ quote.text }}"</p>
          <p class="text-gray-600 font-semibold mt-2">â€” {{ quote.author }}</p>
          <div class="mt-3 flex gap-2 justify-end">
            <button onclick="captureDownload('quote-{{ quote.id }}','quote-{{ quote.id }}.png')" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition">Download</button>
            <button onclick="copyLink('/quote/{{ quote.id }}')" class="bg-indigo-500 text-white px-3 py-1 rounded hover:bg-indigo-600 transition">Share Link</button>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <p class="text-gray-600 text-center">No quotes available. Add one!</p>
      {% endif %}
    </main>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script>
      // Capture the element and download as PNG
      async function captureDownload(elementId, filename) {
        const el = document.getElementById(elementId);
        if (!el) return;

        // Temporarily hide buttons/links inside the card and set a fixed height
        const controls = el.querySelectorAll('button, a');
        const originalDisplays = [];
        controls.forEach((c) => {
          originalDisplays.push(c.style.display);
          c.style.display = 'none';
        });
        const originalHeight = el.style.height;
        const originalOverflow = el.style.overflow;
        // Set a fixed height for consistent screenshots (adjust as needed)
        el.style.height = el.style.height || '260px';
        el.style.overflow = 'hidden';

        try {
          const canvas = await html2canvas(el, { backgroundColor: null, scale: 2 });
          canvas.toBlob((blob) => {
            if (!blob) return;
            downloadBlob(blob, filename);
          }, 'image/png');
        } catch (err) {
          console.error('capture failed', err);
          alert('Failed to capture image');
        } finally {
          // restore controls and styles
          controls.forEach((c, i) => (c.style.display = originalDisplays[i] || ''));
          el.style.height = originalHeight || '';
          el.style.overflow = originalOverflow || '';
        }
      }

      // Copy a link to the quote page to the clipboard (fallback to prompt)
      async function copyLink(path) {
        const full = window.location.origin + path;
        if (navigator.clipboard && navigator.clipboard.writeText) {
          try {
            await navigator.clipboard.writeText(full);
            alert('Link copied to clipboard:\n' + full);
            return;
          } catch (e) {
            // fallback
          }
        }
        // fallback: prompt so user can copy manually
        window.prompt('Copy this link:', full);
      }

      function downloadBlob(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }
    </script>
  </body>
</html>